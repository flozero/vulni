<template>
    <DefaultLayout>
        <div class="rounded-md border">
            <Table>
                <TableHeader>
                <TableRow v-for="headerGroup in table.getHeaderGroups()" :key="headerGroup.id">
                    <TableHead v-for="header in headerGroup.headers" :key="header.id">
                    <FlexRender v-if="!header.isPlaceholder" :render="header.column.columnDef.header" :props="header.getContext()" />
                    </TableHead>
                </TableRow>
                </TableHeader>
                <TableBody>
                    <template v-if="table.getRowModel().rows?.length">
                        <template v-for="row in table.getRowModel().rows" :key="row.id">
                            <TableRow :data-state="row.getIsSelected() && 'selected'">
                                <TableCell v-for="cell in row.getVisibleCells()" :key="cell.id">
                                    <FlexRender :render="cell.column.columnDef.cell" :props="cell.getContext()" />
                                </TableCell>
                            </TableRow>
                            <TableRow v-if="row.getIsExpanded()">
                                <TableCell :colspan="row.getAllCells().length">
                                    {{ JSON.stringify(row.original) }}
                                </TableCell>
                            </TableRow>
                        </template>
                    </template>
                    <TableRow v-else>
                        <TableCell
                            :colspan="columns.length"
                            class="text-center"
                        >
                            <template v-if="vulnStore.vulnerabilitiesFetchStatus === 'pending'">
                                <LoaderCircle 
                                    class="animate-spin"
                                    :size="32"
                                />
                            </template>
                            <template v-else>
                                No results.
                            </template>
                        </TableCell>
                    </TableRow>
                </TableBody>
            </Table>
        </div>
    </DefaultLayout>
</template>

<script setup lang="ts">
    import DefaultLayout from '../components/DefaultLayout.vue'
    import packageJson from "../../../../package.json"
    import { LoaderCircle } from "lucide-vue-next"
    import { computed, onBeforeMount } from 'vue';
    import { useVulnerabilityStore } from '../store';
    import type { Package, PackageContract } from '../services/checkVulnerability';
    import { h } from 'vue'
    import {
        Table,
        TableBody,
        TableCell,
        TableHead,
        TableHeader,
        TableRow,
    } from "@/domains/shared/components/ui/table"
    import type {
        ColumnDef,
    } from '@tanstack/vue-table'
    import {
        getCoreRowModel,
        getExpandedRowModel,
        getFilteredRowModel,
        getPaginationRowModel,
        getSortedRowModel,
        useVueTable,
    } from '@tanstack/vue-table'

    import { FlexRender } from '@tanstack/vue-table'


    const vulnStore = useVulnerabilityStore()

    const columns: ColumnDef<PackageContract>[] = [
        {
            "accessorKey": "id"
        },
        {
            "accessorKey": "name",
            header: 'Package name',
        },
        {
            "accessorKey": "detail",
            header: 'Description',
        },
        {
            "accessorKey": "severity",
            cell: ({row}) => {
                return h('div', {class: getSeverityClasses(row.getValue("severity"))}, row.getValue("severity"))
            }
        }
    ]

    const table = useVueTable({
        data: computed(() => vulnStore.vulnerabilities),
        columns,
        getCoreRowModel: getCoreRowModel(),
        getPaginationRowModel: getPaginationRowModel(),
        getSortedRowModel: getSortedRowModel(),
        getFilteredRowModel: getFilteredRowModel(),
        getExpandedRowModel: getExpandedRowModel()
    })

    const extractPkgs = (pkgs: Record<string, string>): Package[] => {
        return Object.keys(pkgs).map(k => {
            const pkgVersion = (packageJson.dependencies  as Record<string, string>)[k]
            return {
                package: {
                    name: k,
                    ecosystem: "npm"
                },
                version: pkgVersion
            }
        })
    }

    const getSeverityClasses = (severity: PackageContract["severity"]) => {
        const defaultClasses = /** @tw */ "px-2 py-1 rounded-sm text-center font-semibold"
        if (severity === "high") return /** @tw */ `${defaultClasses} bg-red-400 text-red-900`
        if (severity === "moderate") return /** @tw */ `${defaultClasses} bg-orange-400 text-orange-900`
        if (severity === "low")return /** @tw */ `${defaultClasses} border-black`
    } 

    onBeforeMount(async () => {
        const pkgs: Package[] = [
            ...extractPkgs(packageJson.dependencies),
            ...extractPkgs(packageJson.devDependencies)
        ]
        await vulnStore.checkAllVulnerabilities(pkgs)
    })
</script>